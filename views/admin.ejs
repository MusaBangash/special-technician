<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Special Technician</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f7f6f3;
      color: #1a1a1a;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    .header {
      background: #fff;
      border-bottom: 1px solid rgba(0,0,0,.06);
      padding: 20px 0;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
    }
    .header h1 { font-size: 28px; margin-bottom: 5px; }
    .header p { color: #5a5a5a; font-size: 14px; }
    
    /* Nav */
    .nav {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 10px;
    }
    .nav a {
      padding: 10px 16px;
      text-decoration: none;
      color: #5a5a5a;
      font-weight: 500;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      cursor: pointer;
    }
    .nav a.active {
      color: #d4a017;
      border-bottom-color: #d4a017;
    }
    .nav a:hover { color: #1a1a1a; }

    /* Controls */
    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
      font-family: inherit;
    }
    .btn-primary {
      background: #d4a017;
      color: #fff;
    }
    .btn-primary:hover { background: #c9941a; }
    .btn-secondary {
      background: #f0f0f0;
      color: #1a1a1a;
    }
    .btn-secondary:hover { background: #e0e0e0; }
    .btn-danger {
      background: #c62828;
      color: #fff;
    }
    .btn-danger:hover { background: #b61c1c; }

    /* Table */
    .table-wrapper {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead {
      background: #f5f5f5;
      border-bottom: 2px solid #e0e0e0;
    }
    th {
      padding: 16px;
      text-align: left;
      font-weight: 700;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #5a5a5a;
    }
    td {
      padding: 16px;
      border-bottom: 1px solid #f0f0f0;
    }
    tbody tr:hover { background: #fafafa; }
    
    /* Status badge */
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-active {
      background: #e8f5e9;
      color: #2e7d32;
    }
    .badge-inactive {
      background: #ffebee;
      color: #c62828;
    }
    .badge-pending { background: #fff3cd; color: #856404; }
    .badge-assigned { background: #d1ecf1; color: #0c5460; }
    .badge-in-progress { background: #cce5ff; color: #004085; }
    .badge-completed { background: #d4edda; color: #155724; }
    .badge-cancelled { background: #f8d7da; color: #721c24; }
    .badge-admin { background: #e3f2fd; color: #1565c0; font-weight: 600; }
    .badge-customer { background: #f3e5f5; color: #7b1fa2; }

    /* Actions */
    .actions {
      display: flex;
      gap: 8px;
    }
    .actions button {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .btn-edit {
      background: #e3f2fd;
      color: #1976d2;
    }
    .btn-edit:hover { background: #bbdefb; }
    .btn-delete {
      background: #ffebee;
      color: #c62828;
    }
    .btn-delete:hover { background: #ffcdd2; }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: #fff;
      border-radius: 12px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 12px 40px rgba(0,0,0,.14);
    }
    .modal-header { margin-bottom: 24px; }
    .modal-header h2 { font-size: 20px; margin-bottom: 4px; }
    .modal-header p { color: #5a5a5a; font-size: 14px; }

    /* Form */
    .form-group {
      margin-bottom: 18px;
    }
    label {
      display: block;
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #5a5a5a;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #d4a017;
      box-shadow: 0 0 0 3px rgba(212,160,23,.1);
    }

    /* Message */
    .message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    .message.show { display: block; }
    .message.success {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
    }
    .message.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ffcdd2;
    }

    /* Detail group for request details modal */
    .detail-group {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #eee;
    }
    .detail-group:last-child {
      border-bottom: none;
    }
    .detail-group label {
      margin-bottom: 4px;
      color: #999;
      font-weight: 500;
      text-transform: capitalize;
    }
    .detail-group div {
      color: #333;
      font-size: 15px;
      word-break: break-word;
    }
    .detail-group select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 100%;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }
    .empty-state h3 { font-size: 18px; margin-bottom: 8px; color: #5a5a5a; }
    .empty-state p { color: #8c8c8c; }

    /* Loading */
    .loading { text-align: center; padding: 40px; color: #5a5a5a; }

    .tab { display: none; }
    .tab.show { display: block; }

    @media (max-width: 768px) {
      table { font-size: 13px; }
      th, td { padding: 12px; }
      .controls { flex-direction: column; }
      .btn { width: 100%; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="header">
    <div class="container">
      <h1>Admin Panel</h1>
      <p>Manage Service Areas & Requests</p>
    </div>
  </div>

  <div class="container">
    <!-- Navigation -->
    <div class="nav">
      <a class="active" onclick="switchTab('dashboard')">ðŸ“Š Dashboard</a>
      <a onclick="switchTab('areas')">Service Areas</a>
      <a onclick="switchTab('services')">Services & Pricing</a>
      <a onclick="switchTab('requests')">Service Requests</a>
      <a onclick="switchTab('contact')">Contact Info</a>
      <a onclick="switchTab('users')">Users</a>
      <a href="/auth/logout" style="margin-left: auto; color: #c62828;">Logout</a>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab show">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div style="background: linear-gradient(135deg, #d4a017, #f0c84a); color: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">TOTAL REQUESTS</div>
          <div style="font-size: 32px; font-weight: 800;" id="stat-requests">0</div>
          <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">All time</div>
        </div>
        <div style="background: linear-gradient(135deg, #2e7d32, #66bb6a); color: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">COMPLETED</div>
          <div style="font-size: 32px; font-weight: 800;" id="stat-completed">0</div>
          <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Orders</div>
        </div>
        <div style="background: linear-gradient(135deg, #1976d2, #42a5f5); color: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">PENDING</div>
          <div style="font-size: 32px; font-weight: 800;" id="stat-pending">0</div>
          <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">In progress</div>
        </div>
        <div style="background: linear-gradient(135deg, #c62828, #ef5350); color: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">TOTAL REVENUE</div>
          <div style="font-size: 32px; font-weight: 800;" id="stat-revenue">0 SAR</div>
          <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">All time</div>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div style="background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,.06);">
          <h3 style="margin-bottom: 16px; font-size: 16px; font-weight: 700;">Service Distribution</h3>
          <canvas id="serviceChart" height="80"></canvas>
        </div>
        <div style="background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,.06);">
          <h3 style="margin-bottom: 16px; font-size: 16px; font-weight: 700;">Request Status</h3>
          <canvas id="statusChart" height="80"></canvas>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
        <div style="background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,.06);">
          <h3 style="margin-bottom: 16px; font-size: 16px; font-weight: 700;">Requests Over Time</h3>
          <canvas id="trendsChart" height="40"></canvas>
        </div>
      </div>
    </div>

    <!-- Service Areas Tab -->
    <div id="areas-tab" class="tab show">
      <div class="message" id="message"></div>

      <div class="controls">
        <button class="btn btn-primary" onclick="openAddModal()">+ Add New City</button>
        <button class="btn btn-secondary" onclick="loadAreas()">Refresh</button>
      </div>

      <div class="table-wrapper">
        <div id="loading" class="loading">Loading cities...</div>
        <table id="areas-table" style="display: none;">
          <thead>
            <tr>
              <th>City Name</th>
              <th>Arabic Name</th>
              <th>Delivery Time</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="areas-tbody"></tbody>
        </table>
        <div id="empty-state" class="empty-state" style="display: none;">
          <h3>No cities found</h3>
          <p>Add your first service area to get started.</p>
        </div>
      </div>
    </div>

    <!-- Requests Tab -->
    <div id="requests-tab" class="tab">
      <div class="message" id="request-message"></div>
      
      <!-- Filters -->
      <div style="background: #f9f9f9; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
          <div>
            <label for="filterStatus" style="display: block; font-weight: 600; font-size: 13px; margin-bottom: 6px; color: #5a5a5a;">Status</label>
            <select id="filterStatus" onchange="applyFilters()">
              <option value="">All Statuses</option>
              <option value="pending">Pending</option>
              <option value="assigned">Assigned</option>
              <option value="in-progress">In Progress</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          <div>
            <label for="filterStartDate" style="display: block; font-weight: 600; font-size: 13px; margin-bottom: 6px; color: #5a5a5a;">From Date</label>
            <input type="date" id="filterStartDate" onchange="applyFilters()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div>
            <label for="filterEndDate" style="display: block; font-weight: 600; font-size: 13px; margin-bottom: 6px; color: #5a5a5a;">To Date</label>
            <input type="date" id="filterEndDate" onchange="applyFilters()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
          <div>
            <label for="filterSearch" style="display: block; font-weight: 600; font-size: 13px; margin-bottom: 6px; color: #5a5a5a;">Search by Name</label>
            <input type="text" id="filterSearch" placeholder="Customer name..." onkeyup="applyFilters()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div>
            <label for="filterPhone" style="display: block; font-weight: 600; font-size: 13px; margin-bottom: 6px; color: #5a5a5a;">Search by Phone</label>
            <input type="text" id="filterPhone" placeholder="Phone number..." onkeyup="applyFilters()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
        </div>
        <button class="btn btn-secondary" onclick="clearFilters()" style="width: 100%; padding: 8px;">Clear Filters</button>
      </div>
      
      <div class="controls">
        <button class="btn btn-secondary" onclick="loadRequests()">Refresh</button>
        <button class="btn btn-primary" onclick="exportRequests()">ðŸ“¥ Export CSV</button>
      </div>

      <div class="table-wrapper">
        <div id="req-loading" class="loading">Loading requests...</div>
        <table id="requests-table" style="display: none;">
          <thead>
            <tr>
              <th>Customer</th>
              <th>Phone</th>
              <th>Service</th>
              <th>Status</th>
              <th>Date</th>
              <th>Location</th>
              <th>Price</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="requests-tbody"></tbody>
        </table>
        <div id="req-empty-state" class="empty-state" style="display: none;">
          <h3>No service requests yet</h3>
          <p>Service requests will appear here.</p>
        </div>
      </div>
    </div>

    <!-- Contact Tab -->
    <div id="contact-tab" class="tab">
      <div class="message" id="contact-message"></div>
      
      <div class="controls">
        <button class="btn btn-primary" onclick="loadContactInfo()">Refresh</button>
      </div>

      <div class="form-container" style="max-width: 600px;">
        <h3>Edit Contact Information</h3>
        
        <div class="form-group">
          <label for="contactTitle">Title</label>
          <input type="text" id="contactTitle" placeholder="e.g., Ready to get started?">
        </div>

        <div class="form-group">
          <label for="contactDesc">Description</label>
          <textarea id="contactDesc" placeholder="Contact description..." rows="3"></textarea>
        </div>

        <div class="form-group">
          <label for="contactPhone">Phone Number</label>
          <input type="tel" id="contactPhone" placeholder="+966...">
        </div>

        <div class="form-group">
          <label for="contactEmail">Email</label>
          <input type="email" id="contactEmail" placeholder="email@example.com">
        </div>

        <div class="form-group">
          <label for="contactAddress">Address</label>
          <input type="text" id="contactAddress" placeholder="City, Country">
        </div>

        <div class="form-group">
          <label for="contactWhatsapp">WhatsApp Link</label>
          <input type="url" id="contactWhatsapp" placeholder="https://wa.me/...">
        </div>

        <div class="form-group">
          <label for="contactInstagram">Instagram Link</label>
          <input type="url" id="contactInstagram" placeholder="https://instagram.com/...">
        </div>

        <div class="form-group">
          <label for="contactTiktok">TikTok Link</label>
          <input type="url" id="contactTiktok" placeholder="https://tiktok.com/@...">
        </div>

        <div class="form-group">
          <label for="contactSnapchat">Snapchat Link</label>
          <input type="url" id="contactSnapchat" placeholder="https://snapchat.com/...">
        </div>

        <button class="btn btn-primary" onclick="saveContactInfo()" style="width: 100%; margin-top: 20px;">Save Changes</button>
      </div>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab">
      <div class="message" id="users-message"></div>
      <div class="controls">
        <button class="btn btn-primary" onclick="loadUsers()">Refresh Users</button>
      </div>
      <div class="table-wrapper">
        <table id="usersTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Phone</th>
              <th>Email</th>
              <th>Role</th>
              <th>Joined</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="usersBody">
            <tr><td colspan="6" style="text-align: center; padding: 20px;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="services-tab" class="tab">
      <div class="message" id="service-message"></div>

      <div class="controls">
        <button class="btn btn-primary" onclick="openAddServiceModal()">+ Add New Service</button>
        <button class="btn btn-secondary" onclick="loadServices()">Refresh</button>
      </div>

      <div class="table-wrapper">
        <div id="svc-loading" class="loading">Loading services...</div>
        <table id="services-table" style="display: none;">
          <thead>
            <tr>
              <th>Service Name</th>
              <th>Category</th>
              <th>Price (SAR)</th>
              <th>Duration</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="services-tbody"></tbody>
        </table>
        <div id="svc-empty-state" class="empty-state" style="display: none;">
          <h3>No services found</h3>
          <p>Add your first service to get started.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit City Modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Add New City</h2>
      </div>
      <form id="areaForm" onsubmit="submitForm(event)">
        <div class="form-group">
          <label for="cityName">City Name (English)</label>
          <input type="text" id="cityName" required placeholder="e.g., Jazan">
        </div>
        <div class="form-group">
          <label for="arabicName">Arabic Name</label>
          <input type="text" id="arabicName" required placeholder="e.g., Ø¬Ø§Ø²Ø§Ù†">
        </div>
        <div class="form-group">
          <label for="deliveryTime">Delivery Time (hours)</label>
          <input type="number" id="deliveryTime" min="1" max="72" value="24">
        </div>
        <div class="form-group">
          <label for="status">Status</label>
          <select id="status">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        <div class="form-group">
          <label for="notes">Notes (optional)</label>
          <textarea id="notes" rows="3" placeholder="Add any notes..."></textarea>
        </div>
        <div style="display: flex; gap: 12px;">
          <button type="submit" class="btn btn-primary" style="flex: 1;">Save City</button>
          <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add/Edit Service Modal -->
  <div class="modal" id="serviceModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="service-modal-title">Add New Service</h2>
      </div>
      <form id="serviceForm" onsubmit="submitServiceForm(event)">
        <div class="form-group">
          <label for="serviceName">Service Name</label>
          <input type="text" id="serviceName" required placeholder="e.g., AC Unit Cleaning">
        </div>
        <div class="form-group">
          <label for="serviceDescription">Description</label>
          <textarea id="serviceDescription" required rows="3" placeholder="Detailed service description..."></textarea>
        </div>
        <div class="form-group">
          <label for="serviceCategory">Category</label>
          <select id="serviceCategory" required>
            <option value="cleaning">Cleaning</option>
            <option value="repair">Repair</option>
            <option value="maintenance">Maintenance</option>
            <option value="installation">Installation</option>
            <option value="inspection">Inspection</option>
          </select>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div class="form-group">
            <label for="servicePrice">Price (SAR)</label>
            <input type="number" id="servicePrice" min="0" max="10000" required placeholder="150">
          </div>
          <div class="form-group">
            <label for="serviceDuration">Duration (hours)</label>
            <input type="number" id="serviceDuration" min="0.5" max="8" step="0.5" required placeholder="1">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div class="form-group">
            <label for="serviceIcon">Icon (emoji)</label>
            <input type="text" id="serviceIcon" placeholder="ðŸ”§" maxlength="2">
          </div>
          <div class="form-group">
            <label for="serviceStatus">Status</label>
            <select id="serviceStatus">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="serviceNotes">Notes (optional)</label>
          <textarea id="serviceNotes" rows="2" placeholder="Add any notes..."></textarea>
        </div>
        <div style="display: flex; gap: 12px;">
          <button type="submit" class="btn btn-primary" style="flex: 1;">Save Service</button>
          <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeServiceModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Request Details Modal -->
  <div class="modal" id="requestModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Service Request Details</h2>
        <span class="close" onclick="closeRequestModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="message" id="request-detail-message"></div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <!-- Left Column: Request Info -->
          <div>
            <h3>Request Information</h3>
            <div class="detail-group">
              <label for="detail-request-id">Request ID:</label>
              <div id="detail-request-id" style="font-family: monospace; color: #666;"></div>
            </div>
            <div class="detail-group">
              <label for="detail-service">Service:</label>
              <div id="detail-service"></div>
            </div>
            <div class="detail-group">
              <label for="detail-date">Scheduled Date:</label>
              <div id="detail-date"></div>
            </div>
            <div class="detail-group">
              <label for="detail-location">Location:</label>
              <div id="detail-location"></div>
            </div>
            <div class="detail-group">
              <label for="detail-price">Price:</label>
              <div id="detail-price"></div>
            </div>
            <div class="detail-group">
              <label for="detail-status">Status:</label>
              <select id="detail-status" onchange="updateRequestStatus()">
                <option value="pending">Pending</option>
                <option value="assigned">Assigned</option>
                <option value="in-progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
          </div>

          <!-- Right Column: Customer Info & Notes -->
          <div>
            <h3>Customer Information</h3>
            <div class="detail-group">
              <label for="detail-customer-name">Name:</label>
              <div id="detail-customer-name"></div>
            </div>
            <div class="detail-group">
              <label for="detail-customer-phone">Phone:</label>
              <div id="detail-customer-phone"></div>
            </div>
            <div class="detail-group">
              <label for="detail-customer-email">Email:</label>
              <div id="detail-customer-email"></div>
            </div>

            <h3 style="margin-top: 25px;">Notes</h3>
            <label for="detail-notes" style="display: block; font-weight: 600; font-size: 13px; margin-bottom: 6px; color: #5a5a5a;"></label>
            <textarea id="detail-notes" rows="4" placeholder="Add notes about this request..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
          </div>
        </div>

        <div style="margin-top: 25px; display: flex; gap: 12px;">
          <button class="btn btn-primary" onclick="saveRequestChanges()">Save Changes</button>
          <button class="btn btn-secondary" onclick="closeRequestModal()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentAreaId = null;
    let currentServiceId = null;
    let currentRequestId = null;

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('show'));
      document.getElementById(tab + '-tab').classList.add('show');
      document.querySelectorAll('.nav a').forEach(el => el.classList.remove('active'));
      event.target.classList.add('active');
      if (tab === 'dashboard') loadDashboard();
      if (tab === 'areas') loadAreas();
      if (tab === 'services') loadServices();
      if (tab === 'requests') loadRequests();
      if (tab === 'contact') loadContactInfo();
      if (tab === 'users') loadUsers();
    }

    async function loadAreas() {
      try {
        const response = await fetch('/api/areas/all');
        const data = await response.json();
        
        if (!response.ok) {
          showMessage('Error loading areas', 'error');
          return;
        }

        const tbody = document.getElementById('areas-tbody');
        tbody.innerHTML = '';

        if (data.areas.length === 0) {
          document.getElementById('areas-table').style.display = 'none';
          document.getElementById('empty-state').style.display = 'block';
          document.getElementById('loading').style.display = 'none';
          return;
        }

        data.areas.forEach(area => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${area.cityName}</td>
            <td>${area.arabicName}</td>
            <td>${area.deliveryTime} hrs</td>
            <td><span class="badge badge-${area.status}">${area.status}</span></td>
            <td>
              <div class="actions">
                <button class="btn-edit" onclick="editArea('${area._id}')">Edit</button>
                <button class="btn-delete" onclick="deleteArea('${area._id}')">Delete</button>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });

        document.getElementById('areas-table').style.display = 'table';
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('loading').style.display = 'none';
      } catch (error) {
        showMessage('Failed to load areas', 'error');
        console.error(error);
      }
    }

    async function loadRequests() {
      try {
        const status = document.getElementById('filterStatus')?.value || '';
        const startDate = document.getElementById('filterStartDate')?.value || '';
        const endDate = document.getElementById('filterEndDate')?.value || '';

        let url = '/admin/requests';
        const params = new URLSearchParams();
        if (status) params.append('status', status);
        if (startDate) params.append('startDate', startDate);
        if (endDate) params.append('endDate', endDate);
        if (params.toString()) url += '?' + params.toString();

        const response = await fetch(url);
        const data = await response.json();
        
        if (!response.ok) {
          showRequestMessage('Error loading requests', 'error');
          return;
        }

        let requests = data.requests || [];

        // Client-side search filters
        const search = document.getElementById('filterSearch')?.value.toLowerCase() || '';
        const phoneFilter = document.getElementById('filterPhone')?.value.toLowerCase() || '';

        if (search || phoneFilter) {
          requests = requests.filter(req => {
            const name = (req.customer?.name || req.customerName || '').toLowerCase();
            const phone = (req.customer?.phone || req.customerPhone || '').toLowerCase();
            
            // Check name search
            if (search && !name.includes(search)) return false;
            
            // Check phone search
            if (phoneFilter && !phone.includes(phoneFilter)) return false;
            
            return true;
          });
        }

        const tbody = document.getElementById('requests-tbody');
        tbody.innerHTML = '';

        if (requests.length === 0) {
          document.getElementById('requests-table').style.display = 'none';
          document.getElementById('req-empty-state').style.display = 'block';
          document.getElementById('req-loading').style.display = 'none';
          return;
        }

        requests.forEach(req => {
          const date = new Date(req.scheduledDate).toLocaleDateString();
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${req.customer?.name || req.customerName || 'Unknown'}</td>
            <td>${req.customer?.phone || req.customerPhone || 'N/A'}</td>
            <td>${req.service}</td>
            <td><span class="badge badge-${req.status}">${req.status}</span></td>
            <td>${date}</td>
            <td>${req.location}</td>
            <td>${req.price ? req.price + ' SAR' : '-'}</td>
            <td>
              <div class="actions">
                <button class="btn-edit" onclick="viewRequest('${req._id}')">View</button>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });

        document.getElementById('requests-table').style.display = 'table';
        document.getElementById('req-empty-state').style.display = 'none';
        document.getElementById('req-loading').style.display = 'none';
      } catch (error) {
        showRequestMessage('Failed to load requests', 'error');
        console.error(error);
      }
    }

    // Apply filters and reload requests
    function applyFilters() {
      loadRequests();
    }

    // Clear all filters
    function clearFilters() {
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterStartDate').value = '';
      document.getElementById('filterEndDate').value = '';
      document.getElementById('filterSearch').value = '';
      document.getElementById('filterPhone').value = '';
      loadRequests();
    }

    function openAddModal() {
      currentAreaId = null;
      document.getElementById('modal-title').textContent = 'Add New City';
      document.getElementById('areaForm').reset();
      document.getElementById('status').value = 'active';
      document.getElementById('deliveryTime').value = '24';
      document.getElementById('modal').classList.add('show');
    }

    async function editArea(areaId) {
      try {
        const response = await fetch(`/api/areas/${areaId}`);
        const data = await response.json();
        
        if (!response.ok) {
          showMessage('Failed to load area', 'error');
          return;
        }

        currentAreaId = areaId;
        document.getElementById('modal-title').textContent = 'Edit City';
        document.getElementById('cityName').value = data.area.cityName;
        document.getElementById('arabicName').value = data.area.arabicName;
        document.getElementById('deliveryTime').value = data.area.deliveryTime;
        document.getElementById('status').value = data.area.status;
        document.getElementById('notes').value = data.area.notes || '';
        document.getElementById('modal').classList.add('show');
      } catch (error) {
        showMessage('Error loading area details', 'error');
      }
    }

    async function submitForm(e) {
      e.preventDefault();

      const cityName = document.getElementById('cityName').value;
      const arabicName = document.getElementById('arabicName').value;
      const deliveryTime = document.getElementById('deliveryTime').value;
      const status = document.getElementById('status').value;
      const notes = document.getElementById('notes').value;

      try {
        const method = currentAreaId ? 'PUT' : 'POST';
        const url = currentAreaId ? `/api/areas/${currentAreaId}` : '/api/areas';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cityName, arabicName, deliveryTime, status, notes })
        });

        const data = await response.json();

        if (response.ok) {
          showMessage(currentAreaId ? 'City updated successfully!' : 'City added successfully!', 'success');
          closeModal();
          loadAreas();
        } else {
          showMessage(data.error || 'Failed to save city', 'error');
        }
      } catch (error) {
        showMessage('Error saving city', 'error');
        console.error(error);
      }
    }

    async function deleteArea(areaId) {
      if (!confirm('Are you sure you want to delete this city?')) return;

      try {
        const response = await fetch(`/api/areas/${areaId}`, { method: 'DELETE' });
        const data = await response.json();

        if (response.ok) {
          showMessage('City deleted successfully!', 'success');
          loadAreas();
        } else {
          showMessage(data.error || 'Failed to delete city', 'error');
        }
      } catch (error) {
        showMessage('Error deleting city', 'error');
      }
    }

    // View request details
    async function viewRequest(requestId) {
      currentRequestId = requestId;
      try {
        const response = await fetch(`/admin/requests/${requestId}`);
        const data = await response.json();

        if (!response.ok) {
          alert('Error loading request details');
          return;
        }

        const req = data.request;
        const customerData = req.customer || {};
        const scheduledDate = new Date(req.scheduledDate).toLocaleString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        // Populate the modal
        document.getElementById('detail-request-id').textContent = req._id;
        document.getElementById('detail-service').textContent = req.service;
        document.getElementById('detail-date').textContent = scheduledDate;
        document.getElementById('detail-location').textContent = req.location || 'Not specified';
        document.getElementById('detail-price').textContent = req.price ? req.price + ' SAR' : 'Not specified';
        document.getElementById('detail-status').value = req.status;
        document.getElementById('detail-customer-name').textContent = customerData.name || req.customerName || 'Unknown';
        document.getElementById('detail-customer-phone').textContent = customerData.phone || req.customerPhone || 'N/A';
        document.getElementById('detail-customer-email').textContent = customerData.email || 'Not provided';
        document.getElementById('detail-notes').value = req.notes || '';
        document.getElementById('request-detail-message').textContent = '';

        // Show the modal
        document.getElementById('requestModal').classList.add('show');
      } catch (error) {
        console.error('Error loading request:', error);
        alert('Failed to load request details');
      }
    }

    // Update request status
    async function updateRequestStatus() {
      const status = document.getElementById('detail-status').value;
      const notes = document.getElementById('detail-notes').value;

      try {
        const response = await fetch(`/admin/requests/${currentRequestId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status, notes })
        });

        const data = await response.json();

        if (response.ok) {
          document.getElementById('request-detail-message').textContent = 'âœ… Status updated successfully!';
          document.getElementById('request-detail-message').className = 'message show success';
          setTimeout(() => loadRequests(), 1000);
        } else {
          document.getElementById('request-detail-message').textContent = data.error || 'Failed to update status';
          document.getElementById('request-detail-message').className = 'message show error';
        }
      } catch (error) {
        console.error('Error updating status:', error);
        document.getElementById('request-detail-message').textContent = 'Error updating status';
        document.getElementById('request-detail-message').className = 'message show error';
      }
    }

    // Save request changes
    async function saveRequestChanges() {
      const status = document.getElementById('detail-status').value;
      const notes = document.getElementById('detail-notes').value;

      try {
        const response = await fetch(`/admin/requests/${currentRequestId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status, notes })
        });

        const data = await response.json();

        if (response.ok) {
          document.getElementById('request-detail-message').textContent = 'âœ… Changes saved successfully!';
          document.getElementById('request-detail-message').className = 'message show success';
          setTimeout(() => {
            closeRequestModal();
            loadRequests();
          }, 1000);
        } else {
          document.getElementById('request-detail-message').textContent = data.error || 'Failed to save changes';
          document.getElementById('request-detail-message').className = 'message show error';
        }
      } catch (error) {
        console.error('Error saving changes:', error);
        document.getElementById('request-detail-message').textContent = 'Error saving changes';
        document.getElementById('request-detail-message').className = 'message show error';
      }
    }

    // Close request modal
    function closeRequestModal() {
      document.getElementById('requestModal').classList.remove('show');
      currentRequestId = null;
    }

    async function exportRequests() {
      try {
        window.open('/admin/export', '_blank');
      } catch (error) {
        showRequestMessage('Error exporting requests', 'error');
      }
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('show');
      currentAreaId = null;
    }

    // Service Management Functions
    async function loadServices() {
      try {
        const response = await fetch('/api/catalog/all');
        const data = await response.json();
        
        if (!response.ok) {
          showServiceMessage('Error loading services', 'error');
          return;
        }

        const tbody = document.getElementById('services-tbody');
        tbody.innerHTML = '';

        if (data.services.length === 0) {
          document.getElementById('services-table').style.display = 'none';
          document.getElementById('svc-empty-state').style.display = 'block';
          document.getElementById('svc-loading').style.display = 'none';
          return;
        }

        data.services.forEach(service => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><strong>${service.icon} ${service.name}</strong></td>
            <td>${service.category}</td>
            <td><strong>${service.price} SAR</strong></td>
            <td>${service.duration}h</td>
            <td><span class="badge badge-${service.status}">${service.status}</span></td>
            <td>
              <div class="actions">
                <button class="btn-edit" onclick="editService('${service._id}')">Edit</button>
                <button class="btn-delete" onclick="deleteService('${service._id}')">Delete</button>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });

        document.getElementById('services-table').style.display = 'table';
        document.getElementById('svc-empty-state').style.display = 'none';
        document.getElementById('svc-loading').style.display = 'none';
      } catch (error) {
        showServiceMessage('Failed to load services', 'error');
        console.error(error);
      }
    }

    function openAddServiceModal() {
      currentServiceId = null;
      document.getElementById('service-modal-title').textContent = 'Add New Service';
      document.getElementById('serviceForm').reset();
      document.getElementById('serviceStatus').value = 'active';
      document.getElementById('serviceCategory').value = 'cleaning';
      document.getElementById('serviceIcon').value = 'ðŸ”§';
      document.getElementById('serviceDuration').value = '1';
      document.getElementById('serviceModal').classList.add('show');
    }

    async function editService(serviceId) {
      try {
        const response = await fetch(`/api/catalog/${serviceId}`);
        const data = await response.json();
        
        if (!response.ok) {
          showServiceMessage('Failed to load service', 'error');
          return;
        }

        currentServiceId = serviceId;
        document.getElementById('service-modal-title').textContent = 'Edit Service';
        document.getElementById('serviceName').value = data.service.name;
        document.getElementById('serviceDescription').value = data.service.description;
        document.getElementById('serviceCategory').value = data.service.category;
        document.getElementById('servicePrice').value = data.service.price;
        document.getElementById('serviceDuration').value = data.service.duration;
        document.getElementById('serviceIcon').value = data.service.icon;
        document.getElementById('serviceStatus').value = data.service.status;
        document.getElementById('serviceNotes').value = data.service.notes || '';
        document.getElementById('serviceModal').classList.add('show');
      } catch (error) {
        showServiceMessage('Error loading service details', 'error');
      }
    }

    async function submitServiceForm(e) {
      e.preventDefault();

      const name = document.getElementById('serviceName').value;
      const description = document.getElementById('serviceDescription').value;
      const category = document.getElementById('serviceCategory').value;
      const price = parseFloat(document.getElementById('servicePrice').value);
      const duration = parseFloat(document.getElementById('serviceDuration').value);
      const icon = document.getElementById('serviceIcon').value || 'ðŸ”§';
      const status = document.getElementById('serviceStatus').value;
      const notes = document.getElementById('serviceNotes').value;

      try {
        const method = currentServiceId ? 'PUT' : 'POST';
        const url = currentServiceId ? `/api/catalog/${currentServiceId}` : '/api/catalog';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, description, category, price, duration, icon, status, notes })
        });

        const data = await response.json();

        if (response.ok) {
          showServiceMessage(currentServiceId ? 'Service updated successfully!' : 'Service added successfully!', 'success');
          closeServiceModal();
          loadServices();
        } else {
          showServiceMessage(data.error || 'Failed to save service', 'error');
        }
      } catch (error) {
        showServiceMessage('Error saving service', 'error');
        console.error(error);
      }
    }

    async function deleteService(serviceId) {
      if (!confirm('Are you sure you want to delete this service?')) return;

      try {
        const response = await fetch(`/api/catalog/${serviceId}`, { method: 'DELETE' });
        const data = await response.json();

        if (response.ok) {
          showServiceMessage('Service deleted successfully!', 'success');
          loadServices();
        } else {
          showServiceMessage(data.error || 'Failed to delete service', 'error');
        }
      } catch (error) {
        showServiceMessage('Error deleting service', 'error');
      }
    }

    function closeServiceModal() {
      document.getElementById('serviceModal').classList.remove('show');
      currentServiceId = null;
    }

    function showServiceMessage(text, type) {
      const msg = document.getElementById('service-message');
      msg.textContent = text;
      msg.className = `message show ${type}`;
      setTimeout(() => msg.classList.remove('show'), 4000);
    }

    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = `message show ${type}`;
      setTimeout(() => msg.classList.remove('show'), 4000);
    }

    function showRequestMessage(text, type) {
      const msg = document.getElementById('request-message');
      msg.textContent = text;
      msg.className = `message show ${type}`;
      setTimeout(() => msg.classList.remove('show'), 4000);
    }

    function showContactMessage(text, type) {
      const msg = document.getElementById('contact-message');
      msg.textContent = text;
      msg.className = `message show ${type}`;
      setTimeout(() => msg.classList.remove('show'), 4000);
    }

    // Load contact info
    async function loadContactInfo() {
      try {
        const response = await fetch('/api/contact');
        const contact = await response.json();
        
        document.getElementById('contactTitle').value = contact.title || '';
        document.getElementById('contactDesc').value = contact.description || '';
        document.getElementById('contactPhone').value = contact.phone || '';
        document.getElementById('contactEmail').value = contact.email || '';
        document.getElementById('contactAddress').value = contact.address || '';
        document.getElementById('contactWhatsapp').value = contact.whatsappLink || '';
        document.getElementById('contactInstagram').value = contact.instagram || '';
        document.getElementById('contactTiktok').value = contact.tiktok || '';
        document.getElementById('contactSnapchat').value = contact.snapchat || '';
      } catch (error) {
        console.error('Error loading contact:', error);
        showContactMessage('Failed to load contact info', 'error');
      }
    }

    // Save contact info
    async function saveContactInfo() {
      const contactData = {
        title: document.getElementById('contactTitle').value,
        description: document.getElementById('contactDesc').value,
        phone: document.getElementById('contactPhone').value,
        email: document.getElementById('contactEmail').value,
        address: document.getElementById('contactAddress').value,
        whatsappLink: document.getElementById('contactWhatsapp').value,
        instagram: document.getElementById('contactInstagram').value,
        tiktok: document.getElementById('contactTiktok').value,
        snapchat: document.getElementById('contactSnapchat').value
      };

      try {
        const response = await fetch('/api/contact/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(contactData)
        });

        if (response.ok) {
          showContactMessage('âœ… Contact information updated successfully!', 'success');
        } else {
          showContactMessage('Failed to save contact info', 'error');
        }
      } catch (error) {
        console.error('Error saving contact:', error);
        showContactMessage('Error saving contact info', 'error');
      }
    }

    // Load users
    async function loadUsers() {
      try {
        const response = await fetch('/admin/users', {
          method: 'GET',
          credentials: 'same-origin'
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          console.error('API error:', response.status, errorData);
          document.getElementById('users-message').textContent = errorData.error || `Error loading users (${response.status})`;
          document.getElementById('users-message').className = 'message show error';
          return;
        }

        const data = await response.json();
        const tbody = document.getElementById('usersBody');
        tbody.innerHTML = '';

        if (!data.users || data.users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No users found</td></tr>';
          return;
        }

        data.users.forEach(user => {
          const row = document.createElement('tr');
          const joinedDate = new Date(user.createdAt).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });
          
          const roleBadge = user.role === 'admin' 
            ? '<span class="badge badge-admin">Admin</span>' 
            : '<span class="badge badge-customer">Customer</span>';

          row.innerHTML = `
            <td>${user.name}</td>
            <td>${user.phone}</td>
            <td>${user.email || '-'}</td>
            <td>${roleBadge}</td>
            <td>${joinedDate}</td>
            <td>
              ${user.role !== 'admin' ? `<button class="btn-delete" onclick="deleteUser('${user._id}', '${user.name}')">Delete</button>` : '<span style="color: #999;">Protected</span>'}
            </td>
          `;
          tbody.appendChild(row);
        });
        document.getElementById('users-message').textContent = '';
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('users-message').textContent = 'Failed to load users: ' + error.message;
        document.getElementById('users-message').className = 'message show error';
      }
    }

    // Delete user
    async function deleteUser(userId, userName) {
      if (!confirm(`âš ï¸ Delete user "${userName}"?\n\nAll their bookings will be permanently deleted. This cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch(`/admin/users/${userId}/delete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (response.ok) {
          document.getElementById('users-message').textContent = 'âœ… User deleted successfully!';
          document.getElementById('users-message').className = 'message show success';
          setTimeout(() => loadUsers(), 500);
        } else {
          document.getElementById('users-message').textContent = data.error || 'Failed to delete user';
          document.getElementById('users-message').className = 'message show error';
        }
      } catch (error) {
        console.error('Error deleting user:', error);
        document.getElementById('users-message').textContent = 'Error deleting user';
        document.getElementById('users-message').className = 'message show error';
      }
    }

    // Dashboard Charts
    let serviceChart, statusChart, trendsChart;

    async function loadDashboard() {
      try {
        const response = await fetch('/admin/requests');
        const data = await response.json();
        const requests = data.requests || [];

        // Calculate statistics
        const total = requests.length;
        const completed = requests.filter(r => r.status === 'completed').length;
        const pending = requests.filter(r => r.status === 'pending' || r.status === 'assigned').length;
        const revenue = requests.reduce((sum, r) => sum + (r.price || 0), 0);

        // Update stat cards
        document.getElementById('stat-requests').textContent = total;
        document.getElementById('stat-completed').textContent = completed;
        document.getElementById('stat-pending').textContent = pending;
        document.getElementById('stat-revenue').textContent = revenue.toLocaleString() + ' SAR';

        // Service Distribution Chart
        const serviceCounts = {};
        requests.forEach(r => {
          serviceCounts[r.service] = (serviceCounts[r.service] || 0) + 1;
        });

        const serviceCtx = document.getElementById('serviceChart').getContext('2d');
        if (serviceChart) serviceChart.destroy();
        serviceChart = new Chart(serviceCtx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(serviceCounts),
            datasets: [{
              data: Object.values(serviceCounts),
              backgroundColor: ['#d4a017', '#2e7d32', '#1976d2', '#c62828', '#f57c00', '#7b1fa2'],
              borderColor: '#fff',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } }
          }
        });

        // Status Distribution Chart
        const statusCounts = {
          pending: requests.filter(r => r.status === 'pending').length,
          assigned: requests.filter(r => r.status === 'assigned').length,
          'in-progress': requests.filter(r => r.status === 'in-progress').length,
          completed: requests.filter(r => r.status === 'completed').length,
          cancelled: requests.filter(r => r.status === 'cancelled').length
        };

        const statusCtx = document.getElementById('statusChart').getContext('2d');
        if (statusChart) statusChart.destroy();
        statusChart = new Chart(statusCtx, {
          type: 'pie',
          data: {
            labels: ['Pending', 'Assigned', 'In Progress', 'Completed', 'Cancelled'],
            datasets: [{
              data: Object.values(statusCounts),
              backgroundColor: ['#fff3cd', '#d1ecf1', '#cce5ff', '#d4edda', '#f8d7da'],
              borderColor: '#fff',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } }
          }
        });

        // Trends Chart (Requests over last 7 days)
        const last7Days = [];
        const requestsByDay = {};
        
        for (let i = 6; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          last7Days.push(dateStr);
          requestsByDay[dateStr] = 0;
        }

        requests.forEach(r => {
          const date = new Date(r.scheduledDate);
          const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          if (requestsByDay.hasOwnProperty(dateStr)) {
            requestsByDay[dateStr]++;
          }
        });

        const trendsCtx = document.getElementById('trendsChart').getContext('2d');
        if (trendsChart) trendsChart.destroy();
        trendsChart = new Chart(trendsCtx, {
          type: 'line',
          data: {
            labels: last7Days,
            datasets: [{
              label: 'Requests',
              data: last7Days.map(day => requestsByDay[day]),
              borderColor: '#d4a017',
              backgroundColor: 'rgba(212, 160, 23, 0.1)',
              tension: 0.4,
              fill: true,
              pointRadius: 5,
              pointBackgroundColor: '#d4a017',
              pointBorderColor: '#fff',
              pointBorderWidth: 2
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: true } },
            scales: {
              y: { beginAtZero: true, ticks: { stepSize: 1 } }
            }
          }
        });
      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    // Load on page load
    window.addEventListener('load', loadDashboard);

    // Close modals on outside click
    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target.id === 'modal') closeModal();
    });
    
    document.getElementById('serviceModal').addEventListener('click', (e) => {
      if (e.target.id === 'serviceModal') closeServiceModal();
    });

    document.getElementById('requestModal').addEventListener('click', (e) => {
      if (e.target.id === 'requestModal') closeRequestModal();
    });
  </script>
</body>
</html>